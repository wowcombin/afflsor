# PROJECT ARCHITECTURE RULES

## üèóÔ∏è –°–ò–°–¢–ï–ú–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –†–û–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–ö–†–ò–¢–ò–ß–ù–û):
```
junior   - —Å–æ–∑–¥–∞–µ—Ç —Ä–∞–±–æ—Ç—ã, –≤—ã–≤–æ–¥—ã
manager  - —É–ø—Ä–∞–≤–ª—è–µ—Ç Junior, –æ–¥–æ–±—Ä—è–µ—Ç –≤—ã–≤–æ–¥—ã  
tester   - —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–∞–∑–∏–Ω–æ
hr       - —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
cfo      - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
admin    - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
```

### –û–°–ù–û–í–ù–´–ï –¢–ê–ë–õ–ò–¶–´:
```
users            - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
works            - —Ä–∞–±–æ—Ç—ã Junior
work_withdrawals - –≤—ã–≤–æ–¥—ã –ø–æ —Ä–∞–±–æ—Ç–∞–º
casinos          - –∫–∞–∑–∏–Ω–æ
cards            - –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã
banks            - –±–∞–Ω–∫–∏
```

## üîê RLS –ü–û–õ–ò–¢–ò–ö–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

### –ü–†–ê–í–ò–õ–û: –í–°–ï –¢–ê–ë–õ–ò–¶–´ –î–û–õ–ñ–ù–´ –ò–ú–ï–¢–¨ RLS
```sql
-- –í–°–ï–ì–î–ê –≤–∫–ª—é—á–∞—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–æ–ª–∏
CREATE POLICY "policy_name" ON table_name
FOR SELECT USING (
    auth.uid() IN (
        SELECT auth_id FROM users 
        WHERE role IN ('manager', 'admin', 'hr') 
        AND status = 'active'
    )
);
```

### –¢–ò–ü–ò–ß–ù–´–ï –ü–û–õ–ò–¢–ò–ö–ò:
- **users**: manager, hr, admin –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ—Ö
- **works**: Junior –≤–∏–¥–∏—Ç —Å–≤–æ–∏, Manager/Admin –≤–∏–¥—è—Ç –≤—Å–µ
- **work_withdrawals**: Junior –≤–∏–¥–∏—Ç —Å–≤–æ–∏, Manager –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä—è—Ç—å
- **casinos, cards, banks**: –≤—Å–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å

## üîÑ API –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –°–¢–†–£–ö–¢–£–†–ê API:
```
/api/users/          - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
/api/works/          - —Ä–∞–±–æ—Ç—ã Junior
/api/work-withdrawals/ - –≤—ã–≤–æ–¥—ã
/api/manager/        - —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è Manager
/api/currency-rates/ - –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
```

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ API:
```typescript
// 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
const { data: { user }, error } = await supabase.auth.getUser()
if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })

// 2. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
console.log('API called:', { endpoint, user: user.email, params })

// 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
try {
  // –ª–æ–≥–∏–∫–∞
} catch (error) {
  console.error('API Error:', error)
  return NextResponse.json({ 
    error: 'Internal server error',
    details: error.message 
  }, { status: 500 })
}

// 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Zod)
const schema = z.object({ ... })
const validatedData = schema.parse(requestData)
```

## üõ°Ô∏è MIDDLEWARE –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø

### MIDDLEWARE –õ–û–ì–ò–ö–ê:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é Supabase
2. –ü–æ–ª—É—á–∏—Ç—å —Ä–æ–ª—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–æ–ª–∏ –∏ –º–∞—Ä—à—Ä—É—Ç–∞
4. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

### –ó–ê–©–ò–©–ï–ù–ù–´–ï –ú–ê–†–®–†–£–¢–´:
```
/dashboard/junior/*   - —Ç–æ–ª—å–∫–æ junior
/dashboard/manager/*  - —Ç–æ–ª—å–∫–æ manager
/dashboard/admin/*    - —Ç–æ–ª—å–∫–æ admin
```

## üí∞ –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê

### –†–ê–°–ß–ï–¢ –ü–†–û–§–ò–¢–ê:
```
–ü—Ä–æ—Ñ–∏—Ç = –°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ - –°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞
–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ USD = Google –∫—É—Ä—Å * 0.95 (Google rate -5%)
```

### –°–¢–ê–¢–£–°–´ –í–´–í–û–î–û–í:
```
waiting  - –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è Manager
received - –æ–¥–æ–±—Ä–µ–Ω–æ Manager
block    - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ Manager
```

### –í–ê–õ–Æ–¢–´:
```
USD, GBP, EUR, CAD
–í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –≤ USD —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π
```

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –û–¢–õ–ê–î–ö–ê

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
```typescript
// /debug-auth
- Supabase auth status
- User data from users table
- Role and permissions
```

#### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API:
```typescript
// /test-api
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ endpoint
- –°—Ç–∞—Ç—É—Å –∫–æ–¥—ã –∏ –æ—à–∏–±–∫–∏
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü
```

#### 3. –ü—Ä–æ—Å—Ç–æ–π API –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
```typescript
// /api/simple-test
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ JOIN
- –ü–æ—à–∞–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
```

## üìä –ê–ù–ê–õ–ò–¢–ò–ö–ê –ò –ú–ï–¢–†–ò–ö–ò

### –û–°–ù–û–í–ù–´–ï –ú–ï–¢–†–ò–ö–ò:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Junior (–≤—Å–µ–≥–æ/–∞–∫—Ç–∏–≤–Ω—ã—Ö)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–≤–æ–¥–æ–≤ (–æ–∂–∏–¥–∞—é—Ç/–æ–¥–æ–±—Ä–µ–Ω–æ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ)
- –ü—Ä–æ—Ñ–∏—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü)
- –¢–æ–ø –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∑–∏–Ω–æ

### –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –í–ê–õ–Æ–¢:
```typescript
const convertToUSD = (amount: number, currency: string): number => {
  const rates = {
    'USD': 1,
    'GBP': 1.27 * 0.95, // Google rate -5%
    'EUR': 1.09 * 0.95,
    'CAD': 0.74 * 0.95
  }
  return amount * (rates[currency] || 1)
}
```

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê

### –ù–ò–ö–û–ì–î–ê –ù–ï –î–ï–õ–ê–¢–¨:
1. **RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑ –≤—Å–µ—Ö —Ä–æ–ª–µ–π** - –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞—Ç—å manager, admin
2. **API –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å user
3. **–°–ª–æ–∂–Ω—ã–µ JOIN –±–µ–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** - –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–°—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** - —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
5. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ë–î —á–µ—Ä–µ–∑ migrations

### –í–°–ï–ì–î–ê –î–ï–õ–ê–¢–¨:
1. **–ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é** - `npm run build`
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Ä–æ–ª—å** –æ—Ç–¥–µ–ª—å–Ω–æ
3. **–î–æ–±–∞–≤–ª—è—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏** –≤ API
4. **–°–æ–∑–¥–∞–≤–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤ vision/

## üîÑ –ü–†–û–¶–ï–°–° –†–ê–ó–†–ê–ë–û–¢–ö–ò

### –ß–ï–ö-–õ–ò–°–¢ –ü–ï–†–ï–î –ù–ê–ß–ê–õ–û–ú:
- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å vision/ —Ñ–∞–π–ª—ã
- [ ] –ü–æ–Ω—è—Ç—å —Å—Ö–µ–º—É –ë–î
- [ ] –ò–∑—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Å–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å middleware –ª–æ–≥–∏–∫—É

### –ß–ï–ö-–õ–ò–°–¢ –ü–ï–†–ï–î –ö–û–ú–ú–ò–¢–û–ú:
- [ ] `npm run build` —É—Å–ø–µ—à–Ω–æ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ä–æ–ª–∏
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

### –°–¢–†–£–ö–¢–£–†–ê –ö–û–ú–ú–ò–¢–û–í:
```
feat: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è Manager —Ä–æ–ª–∏
fix: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è Manager
debug: –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
```
