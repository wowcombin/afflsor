# КОДЕКС ВЫПОЛНЕНИЯ РАБОТЫ (Cursor/DevOps) — ERP Affectivity

**Цель:** чтобы Cursor (Agent/Inline Edit) строил сайт без ошибок, строго по архитектурным правилам и “7 файлам конструкции проекта” из папки `visio/`.

> Этот документ — единственный источник истины по процессу. Любые противоречия в промптах заменяются правилами ниже.

---

## 0) Контекст и стек
- **Frontend:** Next.js 14 (App Router), TypeScript, Tailwind CSS, Framer Motion, shadcn/ui.
- **Backend:** Next.js API Routes / Edge Routes, Supabase (PostgreSQL), RLS, Zod-схемы валидации.
- **Инфраструктура:** Vercel (превью/прод), GitHub Actions (CI), Sentry (ошибки), Plausible (безcookie‑аналитика).
- **Пакетный менеджер:** `pnpm` (предпочтительно). Node LTS.

**Недопустимо:** добавлять трекеры, обход антифрод‑систем, хранение/показ **CVV** и полного номера карты (**PCI DSS запрещает**). Используем токенизацию и маскирование (последние 4 цифры).

---

## 1) Организация репозитория
```
repo/
  .cursor/
    rules/            # Правила для Cursor (MDC)
  visio/              # 7 файлов конструкции проекта + этот КОДЕКС
  app/                # Next.js App Router
  src/                # Бизнес‑логика, ui/, lib/, server/
  supabase/           # миграции, policies, seeds
  .github/workflows/  # CI
  package.json
  README.md
```
**visio/** (рекомендованная структура и имена — переименовать текущие 7 файлов под эти названия):
1. `01_vision_and_scope.md` — миссия, роли, ограничения.
2. `02_architecture.md` — high‑level диаграмма модулей.
3. `03_ui_ux.md` — дизайн‑система, статусы, таблицы, графики.
4. `04_business_rules.md` — расчёты и формулы (зарплаты/бонусы и т.д.).
5. `05_api_spec.md` — OpenAPI/эндпоинты, контракты.
6. `06_security_and_compliance.md` — безопасность, **PCI DSS**, PII.
7. `07_database_schema.md` — схема БД, миграции, RLS.

> Если текущие файлы уже содержат разделы 11 (API) и 12 (DB) — перенести их в пункты 5 и 7.

---

## 2) Жёсткие правила для Cursor (Agent/Inline Edit)
1. **Контекст сначала**: всегда читать `visio/01…07` и этот КОДЕКС перед генерацией. Если материалов не хватает — предложить доуточнение в PR‑описании (а не генерировать произвольно).
2. **План → патч**: прежде чем править код, написать краткий план изменений и список затрагиваемых файлов. Затем вносить правки минимальным диффом.
3. **Валидация до “готово”**: локально выполнить (или описать в ответе и в CI):
   - `pnpm i`  
   - `pnpm typecheck`  
   - `pnpm lint`  
   - `pnpm test` (минимум smoke)  
   - `pnpm build`
   Нельзя отвечать “готово”, если есть ошибки/варнинги типизации/линта/тестов.
4. **Строгая типобезопасность**: TypeScript `strict: true`, все API‑данные проходят Zod‑валидацию на вход/выход. Типы экспортируются из схем.
5. **Никаких секретов в коде**: переменные только из `.env.*`, схема через Zod (см. §5). Никаких токенов в репозитории/коммитах.
6. **Стабильность импортов**: не переименовывать/перемещать публичные модули без правки всех импортов и соответствующих тестов.
7. **Миграции атомарны**: любая смена БД идёт отдельной миграцией с `down`‑скриптом и обновлением RLS‑политик.
8. **Безопасность превыше**: 
   - **Запрещено** реализовывать или советовать обход антифрода/антидетекта/маскировку отпечатков устройств.  
   - **Запрещено** хранение/показ **CVV** и полного PAN. Разрешены только токены и маскированные поля.  
   - Любые платёжные данные — через сертифицированный провайдер/внешний vault.
9. **Документирование**: при добавлении фичи — обновить `visio/05_api_spec.md` и `visio/07_database_schema.md` (ссылки на миграции и примеры запросов).
10. **Минимум зависимостей**: сначала — стандартные возможности Next.js/TS. Новую либу — только при явном выигрыше, с записью аргументации в PR.

---

## 3) Процесс разработки
- **Ветки**: `main` (prod), `develop` (integration), feature‑ветки `feat/*`, `fix/*`.
- **Коммиты**: Conventional Commits (`feat:`, `fix:`, `chore:`…). Автогенерация CHANGELOG.
- **PR‑чек‑лист (Definition of Done):**
  - [ ] Есть описание задачи и план.
  - [ ] Обновлены типы/Zod‑схемы, автогенерённые типы не руками.
  - [ ] Пройдены команды из §2.3.
  - [ ] Тронутые API задокументированы в `visio/05_api_spec.md`.
  - [ ] Миграции и RLS обновлены, сиды работают.
  - [ ] Нет “скрытых” изменений конфигов/секретов.
  - [ ] UI соответствует `visio/03_ui_ux.md` (tokens, dark mode, a11y).
- **Ревью**: не меньше одного аппрува. Красные CI — нельзя мёрджить.

---

## 4) Качество кода
- ESLint + Prettier, `pnpm lint --max-warnings=0`.
- Стиль: функциональные React‑компоненты, server actions где уместно, разделение UI/бизнес‑логики.
- Ошибки через `Result`‑паттерн или исключения, но все API‑ответы нормализованы.
- Логи: структурированные (console + Sentry), PII не логируем.

---

## 5) Переменные окружения и секреты
Используем типобезопасную схему (Zod):

```ts
// src/env.ts
import { z } from "zod";

const schema = z.object({
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1), // только на сервере/CI
  SENTRY_DSN: z.string().optional(),
  PLAUSIBLE_DOMAIN: z.string().optional(),
  NODE_ENV: z.enum(["development", "test", "production"]),
});

export const ENV = schema.parse({
  NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
  NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY,
  SENTRY_DSN: process.env.SENTRY_DSN,
  PLAUSIBLE_DOMAIN: process.env.PLAUSIBLE_DOMAIN,
  NODE_ENV: process.env.NODE_ENV,
});
```

**Правила:**
- Не использовать сервис‑ключ в клиентском коде.
- Для локалки — `.env.local`, для Vercel — Env Groups, доступ только по ролям.
- Секреты никогда не коммитим.

---

## 6) БД, миграции, RLS
- Инструмент: `supabase` CLI (`supabase/migrations/*`).
- Каждая таблица имеет RLS‑политики. Любое изменение таблиц требует проверку RLS.
- **Гейт перед деплоем**: задача CI запускает smoke‑скрипт, проверяющий, что RLS запрещает несанкционированный доступ.

Пример политики (эскиз):
```sql
alter table employees enable row level security;

-- Только владелец записи или роль HR/CFO/Manager
create policy "read_own_or_role" on employees
for select using (
  auth.uid() = user_id or
  exists (select 1 from user_roles ur where ur.user_id = auth.uid() and ur.role in ('HR','CFO','Manager','Admin'))
);
```

---

## 7) API
- Валидация входа/выхода через Zod. Типы экспортируются.
- Ошибки: единый формат `{ error: { code, message } }`.
- Версионирование: `/api/v1/...`.
- Документация: `visio/05_api_spec.md` (OpenAPI), CI проверяет актуальность.

---

## 8) UI/UX стандарты
- Tailwind токены в `tailwind.config.ts`, дизайн‑токены и тёмная тема.
- shadcn/ui — для базовых компонентов. Не править библиотечные файлы без форка.
- A11y: `aria-*`, контраст, фокус‑кольца. Формы через React Hook Form + Zod resolver.
- Графики — Recharts.

---

## 9) Тестирование
- Unit: Vitest.
- E2E: Playwright (критические пользовательские сценарии).
- Минимум один smoke‑тест на каждую критическую фичу.
- Покрытие не ниже 70% на критических модулях.

---

## 10) CI/CD и деплой
- GitHub Actions: линт/типчек/тесты/сборка. Превью‑деплой в Vercel для каждого PR.
- Прод — только из `main` после зелёного CI.
- Rollback: откат билда в Vercel + откат миграции (`down`).

---

## 11) Наблюдаемость и приватность
- Sentry для ошибок (DSN только на сервере).
- Plausible для метрик без cookie.
- Логи никак не содержат PII/платёжные данные.

---

## 12) Известные слабые места Cursor и меры
- **Придумывает файлы/экспорты** → Всегда делать глобальный поиск перед изменениями, не создавать модули с конфликтующими именами.
- **Игнорирует тип‑ошибки** → Обязателен `pnpm typecheck` и отказ от “готово” при ошибках.
- **Ломает импорты при рефакторинге** → После перемещений — автопочинка импортов и `pnpm build`.
- **Недописанные миграции** → Любая миграция сопровождается `down` и тестом на сиды.
- **Забывает обновить доки** → PR не проходит ревью без правок в `visio/05` и `visio/07`.

---

## 13) Быстрый старт (локально)
```bash
# зависимости
corepack enable && corepack prepare pnpm@latest --activate
pnpm i

# подготовка env
cp .env.example .env.local  # заполнить по §5

# типы/линт/сборка
pnpm typecheck && pnpm lint && pnpm build

# dev
pnpm dev
```

---

## 14) Политики комплаенса (обязательно)
- **PCI DSS**: не хранить и не отображать **CVV** и полный PAN. Использовать провайдера токенизации. Логи/бэкапы без платёжных данных.
- **Security by design**: минимум прав, RLS, audit trail, шифрование секретов.
- **Этика**: отказ от функций обхода антифрода/антидетекта и подобных практик.

---

**Определение готовности релиза:** зелёный CI, прохождение чек‑листа §3, актуальные миграции и RLS, документация в `visio/` обновлена.

